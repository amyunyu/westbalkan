import React, { useState, useEffect, useRef } from 'react';
import { 
  MapPin, 
  Calendar, 
  Clock, 
  ChevronLeft, 
  Plane, 
  Info, 
  Sun, 
  CloudRain, 
  Cloud, 
  Camera, 
  Coffee, 
  Utensils, 
  BedDouble, 
  Star,
  Compass,
  ArrowRight
} from 'lucide-react';

// --- Data & Configuration ---

const MORANDI_COLORS = {
  bg: 'bg-[#FDFCF8]', // Pale cream
  primary: 'bg-[#8F9E9D]', // Sage Green
  secondary: 'bg-[#D4C4B7]', // Muted Clay
  accent: 'bg-[#E6DECA]', // Warm Sand
  text: 'text-[#4A4A4A]', // Soft Charcoal
  textLight: 'text-[#8C8C8C]',
  card: 'bg-white',
  highlight: 'text-[#C78F76]' // Terracotta for highlights
};

// Weather Mock Data
const getWeather = (dayIndex) => {
  const weathers = [
    { temp: 24, icon: <Sun size={16} className="text-yellow-500" />, desc: '晴朗' },
    { temp: 22, icon: <Cloud size={16} className="text-gray-400" />, desc: '多雲' },
    { temp: 26, icon: <Sun size={16} className="text-orange-400" />, desc: '艷陽' },
    { temp: 20, icon: <CloudRain size={16} className="text-blue-400" />, desc: '午後陣雨' },
  ];
  // Deterministic "random" based on day index
  return weathers[dayIndex % weathers.length];
};

// Generate Dates from 2026-05-24 to 2026-06-12
const generateDates = () => {
  const dates = [];
  const start = new Date(2026, 4, 24); // Month is 0-indexed (4 is May)
  const end = new Date(2026, 5, 12);   // 5 is June
  
  let current = start;
  let dayCount = 1;

  while (current <= end) {
    dates.push({
      dateObj: new Date(current),
      dayNum: dayCount,
      dayString: `${current.getMonth() + 1}/${current.getDate()}`,
      weekDay: current.toLocaleDateString('zh-TW', { weekday: 'short' })
    });
    current.setDate(current.getDate() + 1);
    dayCount++;
  }
  return dates;
};

const tripDates = generateDates();

// Mock Itinerary Data (Sample for key days, utilizing generic structure for others)
const itineraryData = {
  1: [ // 5/24
    {
      id: 'd1-1',
      time: '18:30',
      title: '前往機場',
      type: 'transport',
      icon: <Plane size={18} />,
      note: '記得檢查護照',
      location: '桃園國際機場',
      desc: '準備出發前往西巴爾幹半島！建議提早3小時抵達機場辦理登機手續。',
      tips: ['檢查電源轉接頭', '下載離線地圖', '攜帶頸枕']
    },
    {
      id: 'd1-2',
      time: '21:00',
      title: '飛往杜布羅夫尼克',
      type: 'transport',
      icon: <Plane size={18} />,
      note: '需轉機',
      location: '伊斯坦堡機場 (轉機)',
      desc: '長途飛行，請多補充水分。預計在伊斯坦堡轉機。',
      tips: ['機上保濕', '調整手錶時差']
    }
  ],
  2: [ // 5/25
    {
      id: 'd2-1',
      time: '13:00',
      title: '抵達杜布羅夫尼克',
      type: 'arrival',
      icon: <MapPin size={18} />,
      note: '入境卡填寫',
      location: 'Dubrovnik Airport',
      desc: '歡迎來到「亞得里亞海的珍珠」！通關後領取行李，前往租車櫃檯或搭乘接駁車。',
      tips: ['機場換匯匯率較差，建議到市區再換', '購買當地 SIM 卡']
    },
    {
      id: 'd2-2',
      time: '15:30',
      title: '入住飯店',
      type: 'hotel',
      icon: <BedDouble size={18} />,
      note: 'Check-in',
      location: 'Hotel Excelsior Dubrovnik',
      desc: '飯店位於普洛切區，享有舊城區和亞得里亞海的壯麗景色。',
      tips: ['確認早餐時間', '詢問櫃檯附近推薦餐廳']
    },
    {
      id: 'd2-3',
      time: '17:30',
      title: '舊城區漫步',
      type: 'sightseeing',
      icon: <Camera size={18} />,
      note: '絕美夕陽',
      location: 'Stradun, Dubrovnik',
      desc: '史特拉敦大道（Stradun）是舊城區的主要街道，兩旁皆是保存完好的巴洛克式建築。傍晚時分光線最美。',
      tips: ['必吃冰淇淋', '參觀歐諾弗利歐水池']
    }
  ],
  3: [ // 5/26
    {
      id: 'd3-1',
      time: '09:00',
      title: '古城牆巡禮',
      type: 'sightseeing',
      icon: <Camera size={18} />,
      note: '權力遊戲場景',
      location: 'Walls of Dubrovnik',
      desc: '全長近2公里的古城牆，是防禦工事的傑作。在這裡可以俯瞰紅瓦屋頂與蔚藍大海的對比。',
      tips: ['建議早上前往避開人潮', '攜帶足夠的水', '穿著舒適好走的鞋']
    },
    {
      id: 'd3-2',
      time: '12:30',
      title: '海鮮午餐',
      type: 'food',
      icon: <Utensils size={18} />,
      note: '已訂位',
      location: 'Proto Fish Restaurant',
      desc: '成立於1886年的老字號餐廳，提供正宗的達爾馬提亞海鮮料理。',
      tips: ['推薦墨魚燉飯', '烤魚拼盤']
    },
    {
      id: 'd3-3',
      time: '15:00',
      title: '搭纜車上山',
      type: 'activity',
      icon: <Compass size={18} />,
      note: '俯瞰全景',
      location: 'Dubrovnik Cable Car',
      desc: '搭乘纜車前往 Srđ 山頂，只需4分鐘即可將杜布羅夫尼克舊城、水晶般的亞得里亞海和眾多島嶼盡收眼底。',
      tips: ['山頂風大建議帶薄外套', '日落時分景色最迷人']
    }
  ],
  // ... Assuming standard itinerary fills here. 
  // For demo purposes, mapping day 4-19 to generic structure if data missing
  20: [ // 6/12
     {
      id: 'd20-1',
      time: '06:00',
      title: '抵達台灣',
      type: 'arrival',
      icon: <MapPin size={18} />,
      note: '平安回家',
      location: '桃園國際機場',
      desc: '旅程結束，帶著滿滿的回憶回到溫暖的家。',
      tips: ['整理照片', '補眠調整時差']
    }
  ]
};

// Generic filler for days without specific data in this demo
const getDayEvents = (dayNum) => {
  if (itineraryData[dayNum]) return itineraryData[dayNum];
  
  return [
    {
      id: `gen-${dayNum}-1`,
      time: '09:30',
      title: '城市探索',
      type: 'sightseeing',
      icon: <Camera size={18} />,
      note: '自由活動',
      location: 'City Center',
      desc: '享受當地的早晨氛圍，探索巷弄間的驚喜。',
      tips: ['尋找當地咖啡館', '購買紀念品']
    },
    {
      id: `gen-${dayNum}-2`,
      time: '13:00',
      title: '當地美食饗宴',
      type: 'food',
      icon: <Utensils size={18} />,
      note: '午餐',
      location: 'Local Restaurant',
      desc: '品嚐西巴爾幹半島的特色料理，如烤肉卷 (Ćevapi) 或布雷克餅 (Burek)。',
      tips: ['嘗試當地啤酒或葡萄酒']
    },
    {
      id: `gen-${dayNum}-3`,
      time: '16:00',
      title: '午後休憩',
      type: 'relax',
      icon: <Coffee size={18} />,
      note: '咖啡時光',
      location: 'Old Town Cafe',
      desc: '在露天咖啡座休息，觀察路人，享受悠閒的歐洲步調。',
      tips: []
    }
  ];
};

// --- Components ---

const DetailView = ({ item, onClose }) => {
  if (!item) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity duration-300"
        onClick={onClose}
      />
      
      {/* Card Content */}
      <div className="relative w-full max-w-md h-[85vh] sm:h-[800px] bg-[#FDFCF8] rounded-t-3xl sm:rounded-3xl shadow-2xl overflow-hidden pointer-events-auto flex flex-col transform transition-transform duration-300 ease-out translate-y-0">
        
        {/* Header Image Area (Abstract) */}
        <div className={`h-48 ${MORANDI_COLORS.secondary} relative flex items-center justify-center`}>
          <button 
            onClick={onClose}
            className="absolute top-4 left-4 p-2 bg-white/50 backdrop-blur-md rounded-full hover:bg-white/80 transition-colors"
          >
            <ChevronLeft size={24} className={MORANDI_COLORS.text} />
          </button>
          <div className="text-6xl opacity-20 text-white">
            {item.icon}
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-8">
          <div className="flex items-center gap-2 mb-2">
            <span className={`px-3 py-1 rounded-full text-xs font-medium ${MORANDI_COLORS.primary} text-white`}>
              {item.time}
            </span>
            <span className="text-xs text-gray-500 uppercase tracking-wider">{item.type}</span>
          </div>

          <h2 className={`text-2xl font-serif font-bold mb-4 ${MORANDI_COLORS.text}`}>
            {item.title}
          </h2>

          <div className="flex items-start gap-2 mb-6 text-sm text-gray-600">
            <MapPin size={16} className="mt-1 flex-shrink-0 text-gray-400" />
            <span>{item.location}</span>
          </div>

          <div className="prose prose-sm mb-8">
            <h3 className={`text-lg font-medium mb-2 ${MORANDI_COLORS.highlight}`}>關於此行程</h3>
            <p className="text-gray-600 leading-relaxed text-justify">
              {item.desc}
            </p>
          </div>

          {item.tips && item.tips.length > 0 && (
            <div className={`p-5 rounded-2xl ${MORANDI_COLORS.accent} bg-opacity-30`}>
              <h3 className={`text-sm font-bold mb-3 flex items-center gap-2 ${MORANDI_COLORS.text}`}>
                <Star size={16} /> 貼心小提醒
              </h3>
              <ul className="space-y-2">
                {item.tips.map((tip, idx) => (
                  <li key={idx} className="flex items-start gap-2 text-sm text-gray-700">
                    <span className="mt-1.5 w-1.5 h-1.5 rounded-full bg-gray-400 flex-shrink-0" />
                    {tip}
                  </li>
                ))}
              </ul>
            </div>
          )}

          <a 
            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`}
            target="_blank"
            rel="noreferrer"
            className={`mt-8 w-full py-4 rounded-xl ${MORANDI_COLORS.primary} text-white font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-opacity shadow-lg shadow-gray-200`}
          >
            <MapPin size={18} />
            開啟 Google Maps
          </a>
        </div>
      </div>
    </div>
  );
};

const InfoPage = () => {
  return (
    <div className="p-6 pb-24 space-y-6 animate-fade-in">
      <h2 className={`text-2xl font-serif font-bold ${MORANDI_COLORS.text}`}>旅遊資訊</h2>
      
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div className="flex items-center gap-3 mb-4">
          <Plane className="text-gray-400" />
          <h3 className="font-bold text-lg text-gray-700">航班資訊</h3>
        </div>
        <div className="space-y-4">
          <div className="border-l-2 border-gray-200 pl-4">
            <p className="text-xs text-gray-400">去程 5/24</p>
            <p className="font-medium text-gray-800">TK025 TPE - IST</p>
            <p className="text-sm text-gray-500">21:55 - 05:10 (+1)</p>
          </div>
          <div className="border-l-2 border-gray-200 pl-4">
            <p className="text-xs text-gray-400">轉機 5/25</p>
            <p className="font-medium text-gray-800">TK439 IST - DBV</p>
            <p className="text-sm text-gray-500">07:30 - 08:20</p>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div className="flex items-center gap-3 mb-4">
          <Info className="text-gray-400" />
          <h3 className="font-bold text-lg text-gray-700">行前清單</h3>
        </div>
        <ul className="space-y-3">
          {['護照 (效期6個月以上)', '歐元現金', '海外旅遊保險證明', '轉接頭 (歐規雙圓孔)', '常用藥品'].map((item, i) => (
            <li key={i} className="flex items-center gap-3 text-sm text-gray-600">
              <div className={`w-4 h-4 rounded border ${MORANDI_COLORS.primary} flex items-center justify-center`}>
                <div className={`w-2 h-2 rounded-sm ${MORANDI_COLORS.primary}`} />
              </div>
              {item}
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

export default function App() {
  const [activeTab, setActiveTab] = useState('itinerary'); // 'itinerary' | 'info'
  const [selectedDateIdx, setSelectedDateIdx] = useState(0);
  const [viewingItem, setViewingItem] = useState(null);
  const scrollRef = useRef(null);

  const currentDate = tripDates[selectedDateIdx];
  const currentEvents = getDayEvents(currentDate.dayNum);
  const currentWeather = getWeather(selectedDateIdx);

  // Scroll active date into view
  useEffect(() => {
    if (scrollRef.current) {
      const activeEl = scrollRef.current.children[selectedDateIdx];
      if (activeEl) {
        activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }
  }, [selectedDateIdx]);

  return (
    <div className={`min-h-screen ${MORANDI_COLORS.bg} font-sans selection:bg-[#D4C4B7] selection:text-white`}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
          font-family: 'Noto Sans TC', sans-serif;
        }
        .font-serif {
          font-family: 'Noto Serif TC', serif;
        }
        /* Custom Scrollbar for date selector */
        .hide-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .hide-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
      `}</style>

      {/* --- Main Content Area --- */}
      <div className="max-w-md mx-auto bg-[#FDFCF8] min-h-screen relative shadow-2xl overflow-hidden flex flex-col">
        
        {/* Header */}
        <div className="pt-8 px-6 pb-4 bg-white/50 backdrop-blur-sm sticky top-0 z-10">
          <h1 className={`text-2xl font-serif font-bold ${MORANDI_COLORS.text} tracking-wide`}>
            {activeTab === 'itinerary' ? '西巴爾幹之旅' : '旅遊資訊'}
          </h1>
          <p className="text-xs text-gray-500 mt-1 tracking-widest uppercase">
            2026 MAY 24 - JUN 12
          </p>
        </div>

        {activeTab === 'itinerary' ? (
          <>
            {/* Date Selector (Squared, shorter, no gap) */}
            <div className="border-b border-gray-200 bg-white shadow-sm z-0">
              <div 
                ref={scrollRef}
                className="flex overflow-x-auto px-0 hide-scrollbar snap-x"
              >
                {tripDates.map((d, idx) => {
                  const isActive = idx === selectedDateIdx;
                  return (
                    <button
                      key={idx}
                      onClick={() => setSelectedDateIdx(idx)}
                      className={`snap-center flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 transition-colors duration-200 border-r border-gray-50 last:border-0 ${
                        isActive 
                          ? `${MORANDI_COLORS.primary} text-white` 
                          : 'bg-white text-gray-400 hover:bg-gray-50'
                      }`}
                    >
                      <span className="text-[10px] font-medium opacity-80 uppercase tracking-wider">{d.weekDay}</span>
                      <span className="text-lg font-bold leading-none my-0.5">{d.dateObj.getDate()}</span>
                      <span className="text-[9px] opacity-60">D{d.dayNum}</span>
                    </button>
                  );
                })}
              </div>
            </div>

            {/* Scrollable Content */}
            <div className="flex-1 overflow-y-auto pb-24">
              
              {/* Compact Weather Display (Top Right) */}
              <div className="px-6 pt-4 pb-2 flex justify-end">
                <div className={`flex items-center gap-1.5 px-3 py-1 rounded-full ${MORANDI_COLORS.bg} border border-gray-100 shadow-sm`}>
                  <div className="text-gray-400">
                     {currentWeather.icon}
                  </div>
                  <span className={`text-sm font-bold ${MORANDI_COLORS.text}`}>{currentWeather.temp}°</span>
                  <span className="text-xs text-gray-400">{currentWeather.desc}</span>
                </div>
              </div>

              {/* Itinerary List */}
              <div className="px-6 space-y-4">
                
                {/* Removed the '當日行程' header as requested */}

                {currentEvents.map((item, idx) => (
                  <div 
                    key={item.id}
                    onClick={() => setViewingItem(item)}
                    className="group bg-white rounded-xl p-5 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-gray-50 hover:shadow-lg transition-all duration-300 cursor-pointer relative overflow-hidden"
                  >
                    {/* Left Timeline Line */}
                    {idx !== currentEvents.length - 1 && (
                      <div className="absolute left-[29px] top-16 bottom-[-20px] w-[2px] bg-gray-100 group-hover:bg-[#EAEAEA] transition-colors" />
                    )}

                    <div className="flex gap-4">
                      {/* Icon Column */}
                      <div className={`flex-shrink-0 w-12 h-12 rounded-full ${MORANDI_COLORS.bg} flex items-center justify-center text-gray-600 border border-gray-100 z-10`}>
                        {item.icon}
                      </div>

                      {/* Content Column */}
                      <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start">
                          <span className={`text-sm font-medium ${MORANDI_COLORS.highlight} mb-1 block`}>
                            {item.time}
                          </span>
                          {/* Map Pin Button */}
                          <button 
                            onClick={(e) => {
                              e.stopPropagation();
                              window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank');
                            }}
                            className={`p-2 rounded-full ${MORANDI_COLORS.bg} text-gray-400 hover:text-[#C78F76] hover:bg-[#FFF] transition-colors`}
                          >
                            <div className="w-5 h-5 flex items-center justify-center rounded-tr-[50%] rounded-tl-[50%] rounded-bl-[50%] rounded-br-0 transform rotate-45 border-2 border-current">
                              <div className="w-1.5 h-1.5 bg-current rounded-full transform -rotate-45" />
                            </div>
                          </button>
                        </div>
                        
                        <h3 className={`text-lg font-bold ${MORANDI_COLORS.text} mb-1 truncate`}>
                          {item.title}
                        </h3>
                        <p className="text-sm text-gray-500 mb-2">{item.location}</p>
                        
                        {item.note && (
                          <span className="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-md">
                            {item.note}
                          </span>
                        )}
                        
                        <div className="flex items-center gap-1 mt-3 text-xs text-gray-400 font-medium group-hover:text-[#AAB7B8] transition-colors">
                          查看詳情 <ArrowRight size={12} />
                        </div>
                      </div>
                    </div>
                  </div>
                ))}

                <div className="h-10 text-center text-xs text-gray-300 pt-4">
                  End of Day {currentDate.dayNum}
                </div>
              </div>
            </div>
          </>
        ) : (
          <InfoPage />
        )}

        {/* Bottom Navigation */}
        <div className="absolute bottom-6 left-6 right-6">
          <div className="bg-white/90 backdrop-blur-md rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.08)] p-1.5 flex justify-between border border-white/50">
            <button
              onClick={() => setActiveTab('itinerary')}
              className={`flex-1 py-3 rounded-full flex items-center justify-center gap-2 text-sm font-medium transition-all duration-300 ${
                activeTab === 'itinerary' 
                  ? `${MORANDI_COLORS.primary} text-white shadow-md` 
                  : 'text-gray-400 hover:bg-gray-50'
              }`}
            >
              <Calendar size={18} />
              每日行程
            </button>
            <button
              onClick={() => setActiveTab('info')}
              className={`flex-1 py-3 rounded-full flex items-center justify-center gap-2 text-sm font-medium transition-all duration-300 ${
                activeTab === 'info' 
                  ? `${MORANDI_COLORS.primary} text-white shadow-md` 
                  : 'text-gray-400 hover:bg-gray-50'
              }`}
            >
              <Info size={18} />
              旅遊資訊
            </button>
          </div>
        </div>

        {/* Details Overlay */}
        <DetailView item={viewingItem} onClose={() => setViewingItem(null)} />

      </div>
    </div>
  );
}
